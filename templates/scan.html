{% extends "base.html" %}

{% block title %}Producto ‚Äî Digital Discos{% endblock %}

{% block content %}
<script>window.DD_API_URL = "{{ api_url }}";</script>
<script>window.DD_QR_CODE  = "{{ qr_code }}";</script>

<style>
  .scan-wrap {
    max-width: 480px;
    margin: 2rem auto;
    padding: 0 1rem 3rem;
  }

  /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
  .scan-card {
    background: var(--card-bg, #1a1a2e);
    border: 1px solid var(--border, #2a2a4a);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0,0,0,.4);
  }

  /* ‚îÄ‚îÄ Image ‚îÄ‚îÄ */
  .scan-img-wrap {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: var(--surface, #12122a);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .scan-img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .scan-img-placeholder {
    font-size: 5rem;
    opacity: .2;
  }

  /* ‚îÄ‚îÄ Body ‚îÄ‚îÄ */
  .scan-body { padding: 1.25rem; }

  /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
  .scan-badges {
    display: flex;
    flex-wrap: wrap;
    gap: .4rem;
    margin-bottom: .75rem;
  }
  .scan-badge {
    font-size: .7rem;
    font-weight: 600;
    padding: .2rem .55rem;
    border-radius: 999px;
    text-transform: uppercase;
    letter-spacing: .04em;
  }
  .scan-badge--cat  { background: rgba(99,102,241,.18); color: #a5b4fc; }
  .scan-badge--type { background: rgba(168,85,247,.18);  color: #d8b4fe; }

  /* ‚îÄ‚îÄ Name / Artist ‚îÄ‚îÄ */
  .scan-name   { font-size: 1.25rem; font-weight: 700; margin: 0 0 .25rem; line-height: 1.3; }
  .scan-artist { font-size: .95rem; color: var(--text-muted, #8888aa); margin: 0 0 1rem; }

  /* ‚îÄ‚îÄ Details grid ‚îÄ‚îÄ */
  .scan-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: .6rem;
    margin-bottom: 1rem;
  }
  .scan-cell {
    background: var(--surface, #12122a);
    border-radius: .5rem;
    padding: .6rem .75rem;
  }
  .scan-cell-label {
    font-size: .68rem;
    color: var(--text-muted, #8888aa);
    text-transform: uppercase;
    letter-spacing: .05em;
    margin-bottom: .15rem;
  }
  .scan-cell-value {
    font-size: .9rem;
    font-weight: 600;
  }

  /* ‚îÄ‚îÄ Prices ‚îÄ‚îÄ */
  .scan-price-lista {
    background: rgba(34,197,94,.1);
    border: 1px solid rgba(34,197,94,.25);
    border-radius: .6rem;
    padding: .75rem;
    margin-bottom: .5rem;
  }
  .scan-price-lista .scan-cell-label { color: #4ade80; }
  .scan-price-lista .scan-cell-value { font-size: 1.15rem; color: #4ade80; }

  .scan-price-secondary {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: .5rem;
    margin-bottom: 1rem;
  }
  .scan-price-cash { background: rgba(99,102,241,.1); border-radius: .5rem; padding: .6rem .75rem; }
  .scan-price-usd  { background: rgba(234,179,8,.1);  border-radius: .5rem; padding: .6rem .75rem; }
  .scan-price-cash .scan-cell-label { color: #818cf8; }
  .scan-price-cash .scan-cell-value { color: #818cf8; }
  .scan-price-usd  .scan-cell-label { color: #fbbf24; }
  .scan-price-usd  .scan-cell-value { color: #fbbf24; }

  /* ‚îÄ‚îÄ Long text ‚îÄ‚îÄ */
  .scan-section-title {
    font-size: .8rem;
    font-weight: 600;
    color: var(--text-muted, #8888aa);
    text-transform: uppercase;
    letter-spacing: .05em;
    margin: 1rem 0 .4rem;
  }
  .scan-tracklist {
    font-size: .82rem;
    color: var(--text-muted, #8888aa);
    background: var(--surface, #12122a);
    border-radius: .5rem;
    padding: .75rem;
    white-space: pre-line;
    max-height: 9rem;
    overflow-y: auto;
  }
  .scan-desc {
    font-size: .9rem;
    color: var(--text-muted, #8888aa);
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .scan-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: .5rem;
    width: 100%;
    padding: .7rem;
    border-radius: .6rem;
    border: none;
    font-size: .9rem;
    font-weight: 600;
    cursor: pointer;
    margin-top: .5rem;
    transition: opacity .15s;
  }
  .scan-btn:hover { opacity: .85; }
  .scan-btn--spotify { background: rgba(34,197,94,.15); color: #4ade80; }
  .scan-btn--share   { background: var(--surface, #12122a); color: var(--text, #e0e0f0); }

  /* ‚îÄ‚îÄ Loading / Error ‚îÄ‚îÄ */
  .scan-state {
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 1rem;
    color: var(--text-muted, #8888aa);
  }
  .scan-spinner {
    width: 2.5rem;
    height: 2.5rem;
    border: 3px solid rgba(99,102,241,.2);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin .7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .scan-error-icon { font-size: 3.5rem; }
  .scan-error-title { font-size: 1.1rem; font-weight: 700; color: var(--text, #e0e0f0); }

  /* ‚îÄ‚îÄ Consultar placeholder ‚îÄ‚îÄ */
  .scan-consultar { font-style: italic; color: #f59e0b; }
</style>

<!-- Estado: cargando -->
<div class="scan-wrap" id="scan-loading">
  <div class="scan-state">
    <div class="scan-spinner"></div>
    <p>Cargando producto‚Ä¶</p>
  </div>
</div>

<!-- Estado: error -->
<div class="scan-wrap" id="scan-error" style="display:none">
  <div class="scan-state">
    <div class="scan-error-icon">üîç</div>
    <p class="scan-error-title">Producto no encontrado</p>
    <p>El c√≥digo QR escaneado no corresponde a ning√∫n producto en nuestro cat√°logo.</p>
    <a href="/" class="btn-portal" style="margin-top:.5rem">Ir al inicio</a>
  </div>
</div>

<!-- Estado: producto -->
<div class="scan-wrap" id="scan-product" style="display:none">
  <div class="scan-card">

    <!-- Imagen -->
    <div class="scan-img-wrap" id="scan-img-wrap">
      <span class="scan-img-placeholder">üíø</span>
    </div>

    <div class="scan-body">

      <!-- Badges -->
      <div class="scan-badges" id="scan-badges"></div>

      <!-- Nombre y artista -->
      <h1 class="scan-name"   id="scan-name"></h1>
      <p  class="scan-artist" id="scan-artist" style="display:none"></p>

      <!-- Grid de detalles -->
      <div class="scan-grid" id="scan-grid"></div>

      <!-- Precio lista -->
      <div class="scan-price-lista" id="scan-precio-lista" style="display:none">
        <div class="scan-cell-label">Precio lista</div>
        <div class="scan-cell-value" id="scan-precio-lista-val"></div>
      </div>

      <!-- Precio efectivo / USD -->
      <div class="scan-price-secondary" id="scan-precio-sec" style="display:none">
        <div class="scan-price-cash" id="scan-precio-cash" style="display:none">
          <div class="scan-cell-label">Efectivo</div>
          <div class="scan-cell-value" id="scan-precio-cash-val"></div>
        </div>
        <div class="scan-price-usd" id="scan-precio-usd" style="display:none">
          <div class="scan-cell-label">USD</div>
          <div class="scan-cell-value" id="scan-precio-usd-val"></div>
        </div>
      </div>

      <!-- Tracklist -->
      <div id="scan-tracklist-wrap" style="display:none">
        <p class="scan-section-title">Lista de temas</p>
        <div class="scan-tracklist" id="scan-tracklist"></div>
      </div>

      <!-- Descripci√≥n -->
      <div id="scan-desc-wrap" style="display:none">
        <p class="scan-section-title">Descripci√≥n</p>
        <p class="scan-desc" id="scan-desc"></p>
      </div>

      <!-- Botones -->
      <div id="scan-actions"></div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const API   = window.DD_API_URL;
  const QR    = window.DD_QR_CODE;

  const elLoading = document.getElementById('scan-loading');
  const elError   = document.getElementById('scan-error');
  const elProduct = document.getElementById('scan-product');

  function show(el) {
    [elLoading, elError, elProduct].forEach(e => e.style.display = 'none');
    el.style.display = '';
  }

  /* ‚îÄ‚îÄ Formateo ‚îÄ‚îÄ */
  function fmtARS(v) {
    if (!v || v === 0) return null;
    return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(v);
  }
  function fmtUSD(v) {
    if (!v || v === 0) return null;
    return 'USD ' + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v);
  }

  /* ‚îÄ‚îÄ Visibilidad seg√∫n view_config ‚îÄ‚îÄ */
  function isVisible(vc, key) {
    if (!vc || !vc.fields) return true;
    const f = vc.fields[key];
    return f ? f.visible !== false : true;
  }
  function showIfEmpty(vc, key) {
    return vc && vc.fields && vc.fields[key] && vc.fields[key].show_if_empty;
  }
  function emptyText(vc, key) {
    return (vc && vc.fields && vc.fields[key] && vc.fields[key].empty_text) || 'Consultar';
  }

  function maybeVal(vc, key, raw) {
    const empty = raw === null || raw === undefined || raw === '' || raw === 0;
    if (!isVisible(vc, key)) return null;           // campo oculto
    if (!empty) return { text: String(raw), consultar: false };
    if (showIfEmpty(vc, key)) return { text: emptyText(vc, key), consultar: true };
    return null;                                    // no mostrar
  }

  /* ‚îÄ‚îÄ Render celda del grid ‚îÄ‚îÄ */
  function addCell(grid, label, val) {
    if (!val) return;
    const d = document.createElement('div');
    d.className = 'scan-cell';
    d.innerHTML = `<div class="scan-cell-label">${label}</div>
      <div class="scan-cell-value${val.consultar ? ' scan-consultar' : ''}">${val.text}</div>`;
    grid.appendChild(d);
  }

  /* ‚îÄ‚îÄ Render principal ‚îÄ‚îÄ */
  function render(product, vc) {
    // Imagen
    const imgWrap = document.getElementById('scan-img-wrap');
    if (product.image_url && isVisible(vc, 'image')) {
      const img = document.createElement('img');
      img.src = product.image_url;
      img.alt = product.name || 'Producto';
      img.onerror = () => { img.style.display = 'none'; };
      imgWrap.innerHTML = '';
      imgWrap.appendChild(img);
    }

    // Badges
    const badges = document.getElementById('scan-badges');
    if (product.category && isVisible(vc, 'category_badge')) {
      badges.innerHTML += `<span class="scan-badge scan-badge--cat">${product.category}</span>`;
    }
    if (product.product_type && isVisible(vc, 'type_badge')) {
      badges.innerHTML += `<span class="scan-badge scan-badge--type">${product.product_type}</span>`;
    }

    // Nombre
    const nameEl = document.getElementById('scan-name');
    nameEl.textContent = product.name || 'Producto';

    // Artista / Marca
    const artistRaw = product.artist || product.brand || '';
    const artistEl  = document.getElementById('scan-artist');
    const artistVal = maybeVal(vc, 'artist', artistRaw);
    if (artistVal) {
      artistEl.textContent = artistVal.text;
      if (artistVal.consultar) artistEl.classList.add('scan-consultar');
      artistEl.style.display = '';
    }

    // Grid de detalles
    const grid = document.getElementById('scan-grid');
    const detailFields = [
      { key: 'year',            label: 'A√±o',         raw: product.year },
      { key: 'format',          label: 'Formato',     raw: product.format },
      { key: 'condicion',       label: 'Condici√≥n',   raw: product.condicion },
      { key: 'condicion_placa', label: 'Cond. placa', raw: product.condicion_placa },
      { key: 'condicion_libro', label: 'Cond. libro', raw: product.condicion_libro },
      { key: 'genre',           label: 'G√©nero',      raw: product.genre },
      { key: 'label',           label: 'Sello',       raw: product.label },
      { key: 'origen',          label: 'Origen',      raw: product.origen },
    ];
    detailFields.forEach(f => addCell(grid, f.label, maybeVal(vc, f.key, f.raw)));

    // Precio lista
    const plVal = maybeVal(vc, 'precio_lista', product.precio_lista);
    if (plVal) {
      const formatted = (!plVal.consultar && fmtARS(product.precio_lista)) || plVal.text;
      document.getElementById('scan-precio-lista-val').textContent = formatted;
      document.getElementById('scan-precio-lista').style.display = '';
    }

    // Precio efectivo y USD
    const pcVal  = maybeVal(vc, 'precio_cash', product.precio_cash);
    const puVal  = maybeVal(vc, 'precio_usd',  product.precio_usd);
    if (pcVal) {
      const formatted = (!pcVal.consultar && fmtARS(product.precio_cash)) || pcVal.text;
      document.getElementById('scan-precio-cash-val').textContent = formatted;
      document.getElementById('scan-precio-cash').style.display = '';
    }
    if (puVal) {
      const formatted = (!puVal.consultar && fmtUSD(product.precio_usd)) || puVal.text;
      document.getElementById('scan-precio-usd-val').textContent = formatted;
      document.getElementById('scan-precio-usd').style.display = '';
    }
    if (pcVal || puVal) {
      document.getElementById('scan-precio-sec').style.display = '';
    }

    // Tracklist
    const tlVal = maybeVal(vc, 'tracklist', product.tracklist);
    if (tlVal) {
      document.getElementById('scan-tracklist').textContent = tlVal.text;
      document.getElementById('scan-tracklist-wrap').style.display = '';
    }

    // Descripci√≥n
    const descRaw = product.descripcion || product.description || '';
    const descVal = maybeVal(vc, 'descripcion', descRaw);
    if (descVal) {
      document.getElementById('scan-desc').textContent = descVal.text;
      document.getElementById('scan-desc-wrap').style.display = '';
    }

    // Botones
    const actions = document.getElementById('scan-actions');

    // Spotify
    const isMusic = product.product_type === 'CD' || product.product_type === 'VINYL' ||
                    product.category === 'MEDIOS_FISICOS';
    const spotifyQ = ((product.artist || product.brand || '') + ' ' + (product.title || product.name || '')).trim();
    if (isMusic && spotifyQ) {
      const btn = document.createElement('button');
      btn.className = 'scan-btn scan-btn--spotify';
      btn.innerHTML = 'üéµ Escuchar en Spotify';
      btn.onclick = () => {
        window.open('https://open.spotify.com/search/' + encodeURIComponent(spotifyQ), '_blank');
      };
      actions.appendChild(btn);
    }

    // Compartir
    if (!vc || vc.enable_share_button !== false) {
      const btnShare = document.createElement('button');
      btnShare.className = 'scan-btn scan-btn--share';
      btnShare.innerHTML = 'üîó Compartir';
      btnShare.onclick = async () => {
        try {
          if (navigator.share) {
            await navigator.share({ title: product.name, url: location.href });
          } else {
            await navigator.clipboard.writeText(location.href);
            btnShare.textContent = '‚úÖ Link copiado';
            setTimeout(() => { btnShare.innerHTML = 'üîó Compartir'; }, 2000);
          }
        } catch (_) {}
      };
      actions.appendChild(btnShare);
    }

    show(elProduct);
  }

  /* ‚îÄ‚îÄ Fetch ‚îÄ‚îÄ */
  fetch(API + '/invman/qr/' + QR + '/info/')
    .then(r => { if (!r.ok) throw new Error('not found'); return r.json(); })
    .then(data => {
      if (!data.product) throw new Error('empty');
      render(data.product, data.view_config || null);
    })
    .catch(() => show(elError));
})();
</script>
{% endblock %}
